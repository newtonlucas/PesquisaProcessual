<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa de Processos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/pp.css') }}">
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header">
                <h4>Pesquisa de Processos no TJSP</h4>
            </div>
            <div class="card-body">
                <div id="loading" style="display: none;" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Iniciando pesquisa... Isso pode levar um momento.</p>
                </div>

                <form id="processo-form">
                    <div class="mb-3">
                        <label for="processos" class="form-label">Números dos Processos (separados por vírgula)</label>
                        <textarea class="form-control" id="processos" name="processos" rows="5" placeholder="0000000-00.0000.8.26.0000, 1111111-11.1111.8.26.1111"></textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Pesquisar por Texto</button>
                    </div>
                </form>
                <hr>
                <form id="upload-form">
                    <div class="mb-3">
                        <label for="file" class="form-label">Ou faça upload de um arquivo .txt</label>
                        <input class="form-control" type="file" id="file" name="file" accept=".txt">
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-secondary">Pesquisar por Arquivo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Define a URL da sua API. Em um cenário real, isso viria de uma configuração.
        const API_URL = 'https://pesquisa-c4hmaugwe4dfbjgw.brazilsouth-01.azurewebsites.net';

        const formTexto = document.getElementById('processo-form');
        const formUpload = document.getElementById('upload-form');
        const loadingDiv = document.getElementById('loading');

        formTexto.addEventListener('submit', async (event) => {
            event.preventDefault();
            const processos = document.getElementById('processos').value;
            if (!processos.trim()) {
                alert('Por favor, insira os números dos processos.');
                return;
            }
            
            loadingDiv.style.display = 'block';
            formTexto.style.display = 'none';
            formUpload.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/api/processar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ processos: processos })
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.statusText}`);
                }

                const data = await response.json();
                window.location.href = `resultados.html?task_id=${data.task_id}`;

            } catch (error) {
                console.error('Erro ao iniciar a pesquisa:', error);
                alert('Falha ao iniciar a pesquisa. Verifique o console para mais detalhes.');
                loadingDiv.style.display = 'none';
                formTexto.style.display = 'block';
                formUpload.style.display = 'block';
            }
        });

        formUpload.addEventListener('submit', async (event) => {
            event.preventDefault();
            const fileInput = document.getElementById('file');
            if (fileInput.files.length === 0) {
                alert('Por favor, selecione um arquivo.');
                return;
            }

            loadingDiv.style.display = 'block';
            formTexto.style.display = 'none';
            formUpload.style.display = 'none';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const response = await fetch(`${API_URL}/api/processar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_contents: e.target.result })
                    });

                    if (!response.ok) {
                        throw new Error(`Erro na API: ${response.statusText}`);
                    }

                    const data = await response.json();
                    window.location.href = `resultados.html?task_id=${data.task_id}`;

                } catch (error) {
                    console.error('Erro ao iniciar a pesquisa com arquivo:', error);
                    alert('Falha ao iniciar a pesquisa com arquivo. Verifique o console para mais detalhes.');
                    loadingDiv.style.display = 'none';
                    formTexto.style.display = 'block';
                    formUpload.style.display = 'block';
                }
            };
            reader.readAsText(fileInput.files[0], 'ISO-8859-1'); // Usando latin-1
        });
    </script>
</body>
</html>